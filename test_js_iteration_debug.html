<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JavaScript Iteration Debug</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("üîç Debugging JavaScript iteration behavior...")
    
    # Test 1: Check what a native JavaScript iterable does
    js_test_native = """
    (function() {
        try {
            console.log('=== Testing native JavaScript iterable ===');
            
            // Create a simple native iterable
            const nativeIterable = {
                [Symbol.iterator]: function() {
                    let count = 0;
                    return {
                        next: function() {
                            if (count < 3) {
                                return { value: count++, done: false };
                            }
                            return { value: undefined, done: true };
                        }
                    };
                }
            };
            
            console.log('Native iterable created');
            console.log('Has Symbol.iterator:', Symbol.iterator in nativeIterable);
            
            // Test for...of on native iterable
            const nativeResults = [];
            for (const value of nativeIterable) {
                nativeResults.push(value);
            }
            
            console.log('Native for...of worked:', nativeResults);
            
            return { success: true, results: nativeResults };
            
        } catch (e) {
            console.log('Native test error:', e.message);
            return { success: false, error: e.message };
        }
    })
    """
    
    from js import eval as js_eval
    native_test = js_eval(js_test_native)
    native_result = native_test()
    
    log_result(f"Native JS iterable test: {native_result.success}")
    if native_result.success:
        log_result(f"Native results: {list(native_result.results)}")
    else:
        log_result(f"Native error: {native_result.error}")
    
    # Test 2: Check if there's something different about our Python object
    log_result("üîç Testing Python object structure...")
    
    class DebugIterable:
        def __init__(self):
            self.access_log = []
        
        def __getitem__(self, key):
            self.access_log.append(f"__getitem__({key}, type: {type(key)})")
            log_result(f"  ACCESS: __getitem__({key}, type: {type(key)})")
            
            if key == Symbol.iterator:
                def iterator_func():
                    class Iterator:
                        def __init__(self):
                            self.count = 0
                        
                        def next(self):
                            if self.count < 3:
                                value = self.count
                                self.count += 1
                                return {"value": value, "done": False}
                            return {"value": None, "done": True}
                    
                    return Iterator()
                
                return create_proxy(iterator_func)
            
            # Log any other access
            raise KeyError(f"Unexpected key access: {key}")
        
        def __getattr__(self, name):
            self.access_log.append(f"__getattr__({name})")
            log_result(f"  ACCESS: __getattr__({name})")
            raise AttributeError(f"No attribute: {name}")
    
    debug_obj = DebugIterable()
    
    # Test 3: Detailed iteration debugging
    js_debug_test = """
    (function(pythonObj) {
        try {
            console.log('=== Debugging Python object iteration ===');
            console.log('Object type:', typeof pythonObj);
            console.log('Object prototype:', Object.getPrototypeOf(pythonObj));
            console.log('Object keys:', Object.keys(pythonObj));
            
            // Check Symbol.iterator access
            const iteratorSymbol = Symbol.iterator;
            console.log('Accessing Symbol.iterator...');
            const iteratorFunc = pythonObj[iteratorSymbol];
            console.log('Iterator function type:', typeof iteratorFunc);
            
            if (iteratorFunc) {
                console.log('Creating iterator...');
                const iterator = iteratorFunc();
                console.log('Iterator type:', typeof iterator);
                console.log('Iterator keys:', Object.keys(iterator));
                
                // Manual iteration
                console.log('Manual iteration test:');
                let result = iterator.next();
                console.log('First next():', result);
                result = iterator.next();
                console.log('Second next():', result);
            }
            
            // Now try for...of and see what gets called
            console.log('Starting for...of iteration...');
            const results = [];
            for (const value of pythonObj) {
                console.log('Got value:', value);
                results.push(value);
                if (results.length > 5) break; // Safety
            }
            
            return { success: true, results: results };
            
        } catch (e) {
            console.log('Debug error:', e.message);
            console.log('Error stack:', e.stack);
            return { success: false, error: e.message, stack: e.stack };
        }
    })
    """
    
    debug_test = js_eval(js_debug_test)
    debug_result = debug_test(debug_obj)
    
    log_result(f"Debug test success: {debug_result.success}")
    if debug_result.success:
        log_result(f"Debug results: {list(debug_result.results)}")
    else:
        log_result(f"Debug error: {debug_result.error}")
    
    log_result(f"All access log: {debug_obj.access_log}")
        
except Exception as e:
    log_result(f"‚ùå Test failed: {e}")
    import traceback
    log_result(f"Traceback: {traceback.format_exc()}")

log_result("JavaScript iteration debug completed")
    </script>
</body>
</html>