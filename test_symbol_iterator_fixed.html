<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Fixed Symbol.iterator Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("üß™ Testing improved Python-side Symbol.iterator assignment...")
    
    # Create a fibonacci generator
    def fibonacci_generator():
        a, b = 0, 1
        for i in range(10):  # Limit to 10 numbers for testing
            yield a
            a, b = b, a + b
    
    iterator_symbol = Symbol.iterator
    log_result(f"Got Symbol.iterator: {iterator_symbol}")
    
    # Test approach: Create a proper iterable wrapper that implements JavaScript iterator protocol
    class JavaScriptIterable:
        def __init__(self, python_generator):
            self.python_generator = python_generator
        
        def __getitem__(self, key):
            if key == iterator_symbol:
                # Return the iterator function that returns an iterator object
                def iterator_func():
                    # Create a proper JavaScript iterator object
                    class JavaScriptIterator:
                        def __init__(self, gen):
                            self.gen = gen
                        
                        def next(self):
                            try:
                                value = next(self.gen)
                                return {"value": value, "done": False}
                            except StopIteration:
                                return {"value": None, "done": True}
                    
                    return JavaScriptIterator(self.python_generator)
                
                return create_proxy(iterator_func)
            
            # Handle other potential property access
            return getattr(self, key, None)
    
    log_result("Creating JavaScript-compatible iterable wrapper...")
    
    fib_gen = fibonacci_generator()
    js_iterable = JavaScriptIterable(fib_gen)
    
    # Test if we can get the iterator
    try:
        iterator_func = js_iterable[iterator_symbol]
        log_result(f"‚úÖ Got iterator function: {iterator_func}")
        
        # Test the iterator manually
        iterator = iterator_func()
        log_result(f"‚úÖ Created iterator: {iterator}")
        
        # Test a few next() calls
        result1 = iterator.next()
        log_result(f"First next(): {result1}")
        
        result2 = iterator.next()
        log_result(f"Second next(): {result2}")
        
        result3 = iterator.next()
        log_result(f"Third next(): {result3}")
        
    except Exception as e:
        log_result(f"‚ùå Manual iterator test failed: {e}")
        import traceback
        log_result(f"Traceback: {traceback.format_exc()}")
    
    # Test JavaScript for...of iteration
    log_result("üéØ Testing JavaScript for...of iteration...")
    
    js_test_code = """
    (function(pythonIterable) {
        try {
            console.log('Testing for...of iteration');
            console.log('Object type:', typeof pythonIterable);
            
            const results = [];
            let count = 0;
            for (const value of pythonIterable) {
                results.push(value);
                count++;
                if (count > 15) break; // Safety limit
            }
            return { success: true, results: results };
        } catch (e) {
            console.log('JS iteration error:', e.message);
            console.log('Error stack:', e.stack);
            return { success: false, error: e.message, stack: e.stack };
        }
    })
    """
    
    from js import eval as js_eval
    test_func = js_eval(js_test_code)
    
    try:
        # Test with fresh generator
        fresh_iterable = JavaScriptIterable(fibonacci_generator())
        result = test_func(fresh_iterable)
        
        log_result(f"JavaScript iteration success: {result.success}")
        if result.success:
            log_result(f"üéâ Fibonacci sequence: {list(result.results)}")
            log_result("‚úÖ SUCCESS: Python-side Symbol.iterator assignment works!")
        else:
            log_result(f"‚ùå JavaScript iteration error: {result.error}")
            if hasattr(result, 'stack'):
                log_result(f"Error stack: {result.stack}")
            
    except Exception as e:
        log_result(f"‚ùå JavaScript test failed: {e}")
        import traceback
        log_result(f"Traceback: {traceback.format_exc()}")
        
except Exception as e:
    log_result(f"‚ùå Test failed: {e}")
    import traceback
    tb = traceback.format_exc()
    log_result(f"Traceback: {tb}")

log_result("Fixed Symbol.iterator test completed")
    </script>
</body>
</html>