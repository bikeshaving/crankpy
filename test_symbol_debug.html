<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Symbol Identity Debug</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("üîç Debugging Symbol.iterator identity issues...")
    
    # Test Symbol identity at different times
    symbol1 = Symbol.iterator
    log_result(f"Symbol1: {symbol1}")
    
    symbol2 = Symbol.iterator
    log_result(f"Symbol2: {symbol2}")
    
    log_result(f"symbol1 == symbol2: {symbol1 == symbol2}")
    log_result(f"symbol1 is symbol2: {symbol1 is symbol2}")
    
    # Test in a class context
    class DebugSymbolWrapper:
        def __init__(self):
            self.stored_symbol = Symbol.iterator
            log_result(f"Stored symbol in __init__: {self.stored_symbol}")
        
        def __getitem__(self, key):
            log_result(f"__getitem__ called with: {key}")
            log_result(f"Stored symbol: {self.stored_symbol}")
            log_result(f"key == stored_symbol: {key == self.stored_symbol}")
            log_result(f"key is stored_symbol: {key is self.stored_symbol}")
            
            # Try fresh Symbol access
            fresh_symbol = Symbol.iterator
            log_result(f"Fresh symbol: {fresh_symbol}")
            log_result(f"key == fresh_symbol: {key == fresh_symbol}")
            log_result(f"key is fresh_symbol: {key is fresh_symbol}")
            
            if key == fresh_symbol:
                log_result("‚úÖ Fresh symbol comparison works!")
                return "SUCCESS"
            elif key == self.stored_symbol:
                log_result("‚úÖ Stored symbol comparison works!")
                return "SUCCESS"
            else:
                log_result("‚ùå No symbol comparison worked")
                return None
    
    debug_wrapper = DebugSymbolWrapper()
    
    # Test access with different symbol sources
    log_result("=== Testing with fresh Symbol.iterator ===")
    try:
        result1 = debug_wrapper[Symbol.iterator]
        log_result(f"Fresh access result: {result1}")
    except Exception as e:
        log_result(f"Fresh access failed: {e}")
    
    log_result("=== Testing with stored symbol ===")
    try:
        result2 = debug_wrapper[symbol1]
        log_result(f"Stored access result: {result2}")
    except Exception as e:
        log_result(f"Stored access failed: {e}")
        
    # Now let's test with our actual SymbolIteratorWrapper
    log_result("=== Testing SymbolIteratorWrapper ===")
    
    from crank import SymbolIteratorWrapper
    
    def test_gen():
        yield "test"
    
    wrapper = SymbolIteratorWrapper(test_gen())
    log_result(f"Created SymbolIteratorWrapper: {wrapper}")
    
    # Debug the wrapper's symbol comparison
    log_result("Testing wrapper symbol access...")
    try:
        result3 = wrapper[Symbol.iterator]
        log_result(f"‚úÖ SymbolIteratorWrapper access succeeded: {type(result3)}")
    except Exception as e:
        log_result(f"‚ùå SymbolIteratorWrapper access failed: {e}")
        
except Exception as e:
    log_result(f"‚ùå Debug test failed: {e}")

log_result("Symbol identity debug completed")
    </script>
</body>
</html>