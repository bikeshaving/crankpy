<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Actual Context Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Object

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("Testing our actual Context implementation...")
    
    # Import our actual Context class
    from crank import Context
    
    log_result("Context imported successfully")
    
    # Test 1: Basic Context creation and iteration
    mock_js_ctx = Object.new()
    mock_js_ctx.props = Object.new()
    mock_js_ctx.props.name = "test"
    
    actual_ctx = Context(mock_js_ctx)
    log_result(f"Actual Context created: {type(actual_ctx)}")
    
    try:
        log_result("Testing actual Context iteration...")
        count = 0
        for props in actual_ctx:
            log_result(f"  ✅ Actual iteration {count}: {props}")
            count += 1
            if count >= 2:
                break
        log_result("✅ Actual Context iteration works!")
    except Exception as e:
        log_result(f"❌ Actual Context iteration failed: {e}")
    
    # Test 2: Compare with working approach
    log_result("Comparing with working approach...")
    
    class WorkingContext:
        def __init__(self, js_context):
            self._js_context = js_context
        
        def __iter__(self):
            def context_generator():
                while True:
                    if hasattr(self._js_context, 'props'):
                        props = self._js_context.props
                        # Convert JS object to Python dict
                        python_props = {}
                        if hasattr(props, 'name'):
                            python_props['name'] = props.name
                        yield python_props
                    else:
                        yield {}
            return context_generator()
    
    working_ctx = WorkingContext(mock_js_ctx)
    
    try:
        log_result("Testing working Context iteration...")
        count = 0
        for props in working_ctx:
            log_result(f"  ✅ Working iteration {count}: {props}")
            count += 1
            if count >= 2:
                break
        log_result("✅ Working Context iteration works!")
    except Exception as e:
        log_result(f"❌ Working Context iteration failed: {e}")
    
    # Test 3: Test the exact difference
    log_result("Investigating the difference...")
    
    # Let's see what our actual Context.__iter__ returns
    try:
        actual_iterator = iter(actual_ctx)
        log_result(f"Actual iterator type: {type(actual_iterator)}")
        
        working_iterator = iter(working_ctx)
        log_result(f"Working iterator type: {type(working_iterator)}")
        
        # Try calling next() on both
        actual_first = next(actual_iterator)
        log_result(f"Actual first result: {actual_first}")
        
        working_first = next(working_iterator)
        log_result(f"Working first result: {working_first}")
        
    except Exception as e:
        log_result(f"❌ Iterator comparison failed: {e}")
    
    # Test 4: Test in component context
    log_result("Testing in component-like function...")
    
    def test_component_actual(ctx):
        log_result("  Component with actual Context called")
        for props in ctx:
            log_result("  Component iteration successful")
            yield f"Result: {props}"
            break
    
    def test_component_working(ctx):
        log_result("  Component with working Context called")
        for props in ctx:
            log_result("  Working component iteration successful")
            yield f"Result: {props}"
            break
    
    try:
        log_result("Testing component with actual Context...")
        gen1 = test_component_actual(actual_ctx)
        result1 = next(gen1)
        log_result(f"✅ Actual Context component: {result1}")
    except Exception as e:
        log_result(f"❌ Actual Context component failed: {e}")
    
    try:
        log_result("Testing component with working Context...")
        gen2 = test_component_working(working_ctx)
        result2 = next(gen2)
        log_result(f"✅ Working Context component: {result2}")
    except Exception as e:
        log_result(f"❌ Working Context component failed: {e}")
        
except Exception as e:
    log_result(f"❌ Test failed: {e}")

log_result("Actual Context test completed")
    </script>
</body>
</html>