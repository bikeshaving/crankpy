<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Raw Generator Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Object, Symbol
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    from crank import h, createElement
    
    log_result("Testing if MicroPython generators work directly with JavaScript...")
    
    # Test 1: Create a raw generator
    def test_generator():
        yield "item1"
        yield "item2"
        yield "item3"
    
    gen = test_generator()
    log_result(f"Generator created: {type(gen)}")
    
    # Test 2: Check if generator has Symbol.iterator (spoiler: it won't)
    iterator_symbol = Symbol.iterator
    try:
        has_symbol_iterator = iterator_symbol in gen
        log_result(f"Generator has Symbol.iterator (in): {has_symbol_iterator}")
    except:
        log_result("Generator 'in' check failed")
    
    try:
        iterator_method = gen[iterator_symbol]
        log_result(f"Generator Symbol.iterator access: {iterator_method}")
    except Exception as e:
        log_result(f"Generator Symbol.iterator access failed: {e}")
    
    # Test 3: Test JavaScript iteration over the generator
    js_test_code = """
    (function(pythonGenerator) {
        try {
            console.log('Testing JavaScript iteration over Python generator');
            console.log('Generator type:', typeof pythonGenerator);
            console.log('Generator:', pythonGenerator);
            
            // Try to iterate using for...of
            const results = [];
            for (const item of pythonGenerator) {
                results.push(item);
            }
            return { success: true, results: results };
        } catch (e) {
            console.log('JavaScript iteration error:', e.message);
            return { success: false, error: e.message };
        }
    })
    """
    
    from js import eval as js_eval
    test_func = js_eval(js_test_code)
    
    # Test with fresh generator
    fresh_gen = test_generator()
    js_result = test_func(fresh_gen)
    
    log_result(f"JavaScript iteration success: {js_result.success}")
    if js_result.success:
        log_result(f"‚úÖ JS results: {js_result.results}")
        log_result("üéâ MicroPython generators work directly with JavaScript!")
    else:
        log_result(f"‚ùå JS iteration error: {js_result.error}")
    
    # Test 4: Test what happens when we return a generator from a component
    log_result("Testing component that returns raw generator...")
    
    def raw_component_func(props, ctx):
        log_result("  Raw component called")
        def component_generator():
            yield createElement("div", None, "Generator item 1")
            yield createElement("div", None, "Generator item 2")
        return component_generator()
    
    # Don't proxy it - test raw
    mock_props = Object.new()
    mock_ctx = Object.new()
    
    try:
        raw_result = raw_component_func(mock_props, mock_ctx)
        log_result(f"Raw component result: {type(raw_result)}")
        
        # Test if Crank.js can iterate over this
        crank_test = test_func(raw_result)
        log_result(f"Crank iteration success: {crank_test.success}")
        if crank_test.success:
            log_result(f"‚úÖ Crank results: {crank_test.results}")
        else:
            log_result(f"‚ùå Crank iteration error: {crank_test.error}")
        
    except Exception as e:
        log_result(f"‚ùå Raw component failed: {e}")
        
except Exception as e:
    log_result(f"‚ùå Test failed: {e}")

log_result("Raw generator test completed")
    </script>
</body>
</html>