<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug Renderer Issue</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="output"></div>
    <div id="render-target"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, console

output_div = document.getElementById("output")
render_target = document.getElementById("render-target")

def log(message):
    output_div.innerHTML += f"<p>{message}</p>"
    console.log(f"[DEBUG] {message}")

log(f"Python implementation: {sys.implementation.name}")

try:
    # Step 1: Test basic imports
    log("Testing imports...")
    from crank import h, component, createElement
    log("✅ Basic imports successful")
    
    # Step 2: Test simple element creation
    log("Testing simple element creation...")
    simple_element = createElement("div", None, "Hello")
    log(f"✅ Simple element created: {type(simple_element)}")
    
    # Step 3: Test h function
    log("Testing h function...")
    h_element = h.div["Hello from h"]
    log(f"✅ h element created: {type(h_element)}")
    
    # Step 4: Test component creation (no rendering)
    log("Testing component decorator...")
    
    @component
    def SimpleComponent(ctx):
        return h.div["Simple component"]
    
    log("✅ Component created successfully")
    
    # Step 5: Test calling component manually
    log("Testing component call...")
    try:
        # Create a mock context like Crank would
        class MockContext:
            def __init__(self):
                self.props = {}
        
        mock_ctx = MockContext()
        mock_props = {}
        
        # Call the component wrapper directly
        result = SimpleComponent(mock_props, mock_ctx)
        log(f"✅ Component call successful: {type(result)}")
    except Exception as e:
        log(f"❌ Component call failed: {e}")
    
    # Step 6: Test renderer import
    log("Testing renderer import...")
    from crank.dom import renderer
    log(f"✅ Renderer imported: {type(renderer)}")
    
    # Step 7: Try to inspect renderer
    log("Inspecting renderer...")
    try:
        log(f"Renderer methods: {dir(renderer)}")
        log(f"Renderer render method: {hasattr(renderer, 'render')}")
    except Exception as e:
        log(f"❌ Renderer inspection failed: {e}")
    
    # Step 8: Try simple rendering
    log("Testing simple rendering...")
    try:
        # Set a timeout to avoid hanging
        import asyncio
        
        # Try the simplest possible render
        simple_div = createElement("div", None, "Test")
        log(f"About to call renderer.render with: {simple_div}")
        
        # This is where it might hang - let's see
        result = renderer.render(simple_div, render_target)
        log(f"✅ Simple render successful: {result}")
        
    except Exception as e:
        log(f"❌ Simple render failed: {e}")
        import traceback
        log(f"Traceback: {traceback.format_exc()}")

except Exception as e:
    log(f"❌ Test failed: {e}")
    import traceback
    log(f"Traceback: {traceback.format_exc()}")

log("Debug test completed")
    </script>
</body>
</html>