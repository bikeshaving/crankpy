<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>MicroPython Direct Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
    
    <!-- Set up our iterable helper -->
    <script>
        window.crankPyCreateIterable = function(items) {
            return {
                [Symbol.iterator]: function() {
                    let index = 0;
                    return {
                        next: function() {
                            if (index < items.length) {
                                return { value: items[index++], done: false };
                            } else {
                                return { value: undefined, done: true };
                            }
                        }
                    };
                }
            };
        };
    </script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config></mpy-config>
    
    <script type="mpy">
import sys
from js import document, window
from pyscript.ffi import create_proxy, to_js

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("Testing MicroPython generator -> iterable conversion...")
    
    # Step 1: Create a simple generator
    def simple_generator():
        yield "item1"
        yield "item2"
        yield "item3"
    
    gen = simple_generator()
    log_result(f"Generator created: {type(gen)}")
    
    # Step 2: Convert to list (what our create_js_iterable does)
    items = list(gen)
    log_result(f"Generator -> list: {items}")
    
    # Step 3: Convert to JS array
    js_items = to_js(items)
    log_result(f"List -> JS array: {type(js_items)}")
    
    # Step 4: Create iterable using our helper
    iterable = window.crankPyCreateIterable(js_items)
    log_result(f"JS iterable created: {type(iterable)}")
    
    # Step 5: Test JavaScript iteration
    test_code = f"""
    (function(iterable) {{
        try {{
            const results = [];
            for (const item of iterable) {{
                results.push(item);
            }}
            return {{ success: true, results: results }};
        }} catch (e) {{
            return {{ success: false, error: e.message }};
        }}
    }})
    """
    
    from js import eval as js_eval
    test_func = js_eval(test_code)
    test_result = test_func(iterable)
    
    log_result(f"JavaScript iteration success: {test_result.success}")
    if test_result.success:
        log_result(f"Results: {test_result.results}")
        log_result("‚úÖ MicroPython -> JavaScript iteration works!")
    else:
        log_result(f"Error: {test_result.error}")
    
    # Step 6: Test creating a component-like function
    log_result("Testing component-like function...")
    
    def component_like_function(props, ctx):
        log_result("  Component function called")
        
        # Simulate what a generator component does
        def component_generator():
            yield "Component output 1"
            yield "Component output 2"
        
        gen = component_generator()
        items = list(gen)
        js_items = to_js(items)
        return window.crankPyCreateIterable(js_items)
    
    # Create proxy
    proxied_component = create_proxy(component_like_function)
    log_result(f"Component proxied: {type(proxied_component)}")
    
    # Test calling it
    from js import Object
    mock_props = Object.new()
    mock_ctx = Object.new()
    
    component_result = proxied_component(mock_props, mock_ctx)
    log_result(f"Component result: {type(component_result)}")
    
    # Test if the result is iterable
    component_test = test_func(component_result)
    log_result(f"Component iteration success: {component_test.success}")
    if component_test.success:
        log_result(f"Component results: {component_test.results}")
        log_result("üéâ FULL SUCCESS! Component pattern works!")
    else:
        log_result(f"Component error: {component_test.error}")
        
except Exception as e:
    log_result(f"‚ùå Test failed: {e}")

log_result("MicroPython direct test completed")
    </script>
</body>
</html>