<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Component Wrapper Debug</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol, Object

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    from crank import createElement, SymbolIteratorWrapper
    
    log_result("üîç Testing component wrapper step by step...")
    
    # Step 1: Test raw function without @component decorator
    def raw_component_func(ctx):
        log_result("raw_component_func called")
        
        def test_gen():
            yield createElement("div", None, "Raw test")
        
        return test_gen()
    
    log_result("=== Testing raw function ===")
    mock_ctx = Object.new()
    
    try:
        raw_result = raw_component_func(mock_ctx)
        log_result(f"‚úÖ Raw function works: {type(raw_result)}")
        
        # Test if raw generator works
        raw_list = list(raw_result)
        log_result(f"‚úÖ Raw generator produces: {len(raw_list)} items")
        
    except Exception as e:
        log_result(f"‚ùå Raw function failed: {e}")
    
    # Step 2: Test manual wrapping with SymbolIteratorWrapper
    log_result("=== Testing manual SymbolIteratorWrapper ===")
    
    def manual_wrapped_func(ctx):
        log_result("manual_wrapped_func called")
        
        def test_gen():
            yield createElement("div", None, "Manual wrapped test")
        
        gen = test_gen()
        wrapped = SymbolIteratorWrapper(gen)
        log_result(f"Created SymbolIteratorWrapper: {type(wrapped)}")
        return wrapped
    
    try:
        manual_result = manual_wrapped_func(mock_ctx)
        log_result(f"‚úÖ Manual wrapping works: {type(manual_result)}")
        
        # Test Symbol.iterator
        iterator_func = manual_result[Symbol.iterator]
        iterator = iterator_func()
        item = iterator.next()
        log_result(f"‚úÖ Manual wrapped iteration: {item}")
        
    except Exception as e:
        log_result(f"‚ùå Manual wrapping failed: {e}")
    
    # Step 3: Test with our component decorator
    log_result("=== Testing @component decorator ===")
    
    from crank import component
    
    @component
    def decorated_component(ctx):
        log_result("decorated_component called")
        
        def test_gen():
            yield createElement("div", None, "Decorated test")
        
        log_result("decorated_component returning generator")
        return test_gen()
    
    log_result(f"Decorated component type: {type(decorated_component)}")
    
    try:
        mock_props = Object.new()
        mock_ctx = Object.new()
        
        log_result("Calling decorated component...")
        decorated_result = decorated_component(mock_props, mock_ctx)
        log_result(f"‚úÖ Decorated component call succeeded: {type(decorated_result)}")
        
        # Test Symbol.iterator on decorated result
        dec_iterator_func = decorated_result[Symbol.iterator]
        dec_iterator = dec_iterator_func()
        dec_item = dec_iterator.next()
        log_result(f"‚úÖ Decorated component iteration: {dec_item}")
        
    except Exception as e:
        log_result(f"‚ùå Decorated component failed: {e}")
        
        # Let's debug what the wrapper function looks like
        log_result("üîç Debugging wrapper function...")
        log_result(f"Wrapper function: {decorated_component}")
        
        # Try to see if there are any proxy issues
        try:
            log_result(f"Wrapper type: {type(decorated_component)}")
            log_result(f"Wrapper dir: {dir(decorated_component)}")
        except Exception as debug_e:
            log_result(f"Debug failed: {debug_e}")
        
except Exception as e:
    log_result(f"‚ùå Test setup failed: {e}")

log_result("Component wrapper debug completed")
    </script>
</body>
</html>