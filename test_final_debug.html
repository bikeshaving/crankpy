<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Final Debug Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config></mpy-config>
    
    <script type="mpy">
import sys
from js import document, Object
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("Final debugging of the exact error point...")
    
    # Create the simplest possible Context
    class DebugContext:
        def __init__(self, js_context):
            self._js_context = js_context
        
        def __iter__(self):
            log_result("    DebugContext.__iter__ called")
            def simple_generator():
                log_result("      Generator function created")
                count = 0
                while count < 3:
                    log_result(f"        Yielding iteration {count}")
                    yield {"count": count}
                    count += 1
            log_result("    Returning generator")
            return simple_generator()
    
    log_result("DebugContext defined")
    
    # Test DebugContext directly
    mock_js_ctx = Object.new()
    debug_ctx = DebugContext(mock_js_ctx)
    
    log_result("Testing DebugContext iteration directly...")
    try:
        for i, props in enumerate(debug_ctx):
            log_result(f"  Direct iteration {i}: {props}")
            if i >= 1:
                break
        log_result("✅ Direct DebugContext iteration works!")
    except Exception as e:
        log_result(f"❌ Direct DebugContext iteration failed: {e}")
    
    # Test in component context
    log_result("Testing DebugContext in component...")
    
    def debug_component(ctx):
        log_result("  debug_component called")
        log_result("  About to start iteration...")
        
        try:
            log_result("  Calling iter(ctx)...")
            iterator = iter(ctx)
            log_result(f"  iter(ctx) succeeded: {type(iterator)}")
            
            log_result("  Starting for loop...")
            for i, props in enumerate(ctx):
                log_result(f"  Loop iteration {i}: {props}")
                yield f"Result {i}: {props}"
                if i >= 0:  # Only do one iteration
                    break
            
            log_result("  ✅ For loop completed!")
            
        except Exception as e:
            log_result(f"  ❌ Error in component iteration: {e}")
            raise
    
    # Test the component directly (no proxy)
    log_result("Testing component directly...")
    try:
        gen = debug_component(debug_ctx)
        result = next(gen)
        log_result(f"✅ Direct component works: {result}")
    except Exception as e:
        log_result(f"❌ Direct component failed: {e}")
    
    # Test with proxy
    log_result("Testing component with proxy...")
    
    def wrapper(props, ctx):
        log_result("  Wrapper called")
        wrapped_ctx = DebugContext(ctx)
        log_result("  DebugContext created in wrapper")
        return debug_component(wrapped_ctx)
    
    proxied = create_proxy(wrapper)
    
    try:
        gen = proxied(Object.new(), mock_js_ctx)
        result = next(gen)
        log_result(f"✅ Proxied component works: {result}")
    except Exception as e:
        log_result(f"❌ Proxied component failed: {e}")
        
except Exception as e:
    log_result(f"❌ Test failed: {e}")

log_result("Final debug test completed")
    </script>
</body>
</html>