<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>JS Object Creation Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol, Object
from pyscript.ffi import create_proxy, to_js

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    # Test accessing Symbol.iterator
    iterator_symbol = Symbol.iterator
    log_result(f"Symbol.iterator available: {iterator_symbol is not None}")
    
    # Test creating a simple Python iterator
    def simple_generator():
        yield "first"
        yield "second" 
        yield "third"
    
    gen = simple_generator()
    log_result(f"Generator created: {type(gen)}")
    
    # Try creating a JavaScript object with Symbol.iterator using to_js
    def make_js_iterator():
        """Create a JavaScript-compatible iterator"""
        gen = simple_generator()
        
        def next_function():
            try:
                value = next(gen)
                return to_js({'value': value, 'done': False})
            except StopIteration:
                return to_js({'value': None, 'done': True})
        
        # Create the iterator object manually
        iterator_obj = Object.new()
        iterator_obj.next = create_proxy(next_function)
        return iterator_obj
    
    def make_iterable():
        """Create a JavaScript-compatible iterable"""
        iterable_obj = Object.new()
        
        # Use bracket notation to set Symbol.iterator
        iterable_obj[iterator_symbol] = create_proxy(make_js_iterator)
        
        return iterable_obj
    
    # Test creating the iterable
    log_result("Creating JavaScript iterable...")
    js_iterable = make_iterable()
    log_result(f"JS iterable created: {type(js_iterable)}")
    
    # Test if it has Symbol.iterator
    has_iterator = iterator_symbol in js_iterable
    log_result(f"Has Symbol.iterator: {has_iterator}")
    
    # Try to get the iterator
    if has_iterator:
        iterator_func = js_iterable[iterator_symbol]
        log_result(f"Iterator function: {type(iterator_func)}")
        
        # Try to call it
        iterator = iterator_func()
        log_result(f"Iterator: {type(iterator)}")
        
        # Try to iterate
        result1 = iterator.next()
        log_result(f"First iteration: {result1.value}, done: {result1.done}")
        
        result2 = iterator.next()
        log_result(f"Second iteration: {result2.value}, done: {result2.done}")
        
except Exception as e:
    log_result(f"‚ùå Test failed: {e}")
    log_result(f"Error type: {type(e).__name__}")

log_result("JS object creation test completed")
    </script>
</body>
</html>