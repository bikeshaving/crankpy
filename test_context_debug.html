<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Context Debug Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Object
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    from crank import Context, h, component
    
    log_result("Step 1: Testing Context creation...")
    
    # Create mock JS context
    mock_js_ctx = Object.new()
    mock_js_ctx.props = Object.new()  # Add props property
    
    python_ctx = Context(mock_js_ctx)
    log_result(f"Context created: {type(python_ctx)}")
    
    log_result("Step 2: Testing Context.__iter__ directly...")
    
    try:
        iterator = iter(python_ctx)
        log_result(f"✅ iter(ctx) works: {type(iterator)}")
        
        # Try getting first item
        first_item = next(iterator)
        log_result(f"✅ next(iterator) works: {type(first_item)}")
        
    except Exception as e:
        log_result(f"❌ Context iteration failed: {e}")
    
    log_result("Step 3: Testing for loop over Context...")
    
    try:
        count = 0
        for item in python_ctx:
            log_result(f"  Context loop {count}: {type(item)}")
            count += 1
            if count >= 2:  # Prevent infinite loop
                break
        log_result("✅ for loop over Context works")
    except Exception as e:
        log_result(f"❌ for loop over Context failed: {e}")
    
    log_result("Step 4: Testing component WITHOUT generator...")
    
    @component
    def NoGenComponent(ctx):
        log_result("  NoGenComponent called")
        # Don't use generator - just return directly
        return h.div["No generator"]
    
    log_result("NoGenComponent defined")
    
    try:
        result = NoGenComponent(mock_js_ctx.props, mock_js_ctx)
        log_result(f"✅ No-gen component works: {type(result)}")
    except Exception as e:
        log_result(f"❌ No-gen component failed: {e}")
    
    log_result("Step 5: Testing component WITH generator but NO context iteration...")
    
    @component
    def NoCtxIterComponent(ctx):
        log_result("  NoCtxIterComponent called")
        # Use generator but don't iterate over ctx
        yield h.div["No ctx iteration"]
        log_result("  NoCtxIterComponent after yield")
    
    log_result("NoCtxIterComponent defined")
    
    try:
        result = NoCtxIterComponent(mock_js_ctx.props, mock_js_ctx)
        log_result(f"✅ No-ctx-iter component works: {type(result)}")
    except Exception as e:
        log_result(f"❌ No-ctx-iter component failed: {e}")
    
    log_result("Step 6: Testing the problematic pattern...")
    
    @component
    def ProblematicComponent(ctx):
        log_result("  ProblematicComponent called")
        log_result("  About to iterate over ctx...")
        for props in ctx:  # ← This is where the error likely happens
            log_result("  In ctx iteration loop")
            yield h.div["Problematic"]
            break  # Only do one iteration
    
    log_result("ProblematicComponent defined")
    
    try:
        result = ProblematicComponent(mock_js_ctx.props, mock_js_ctx)
        log_result(f"✅ Problematic component works: {type(result)}")
    except Exception as e:
        log_result(f"❌ Problematic component failed: {e}")
        
except Exception as e:
    log_result(f"❌ Test failed: {e}")

log_result("Context debug test completed")
    </script>
</body>
</html>