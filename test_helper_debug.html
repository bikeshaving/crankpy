<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Helper Debug Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol, window, eval as js_eval
from pyscript.ffi import to_js

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    # Inject helper function
    log_result("Injecting helper function...")
    js_eval("""
    window.crankPyCreateIterable = function(items) {
        console.log('crankPyCreateIterable called with:', items);
        const obj = {
            [Symbol.iterator]: function() {
                console.log('Symbol.iterator called');
                let index = 0;
                return {
                    next: function() {
                        console.log('next() called, index:', index);
                        if (index < items.length) {
                            return { value: items[index++], done: false };
                        } else {
                            return { value: undefined, done: true };
                        }
                    }
                };
            }
        };
        console.log('Created object:', obj);
        console.log('Object has Symbol.iterator:', Symbol.iterator in obj);
        return obj;
    };
    """)
    
    log_result("Helper function injected")
    
    # Test calling it directly from JavaScript
    log_result("Testing direct JavaScript call...")
    
    test_code = """
    (function() {
        const items = ['test1', 'test2', 'test3'];
        const iterable = window.crankPyCreateIterable(items);
        const hasIterator = Symbol.iterator in iterable;
        return { iterable: iterable, hasIterator: hasIterator };
    })()
    """
    
    js_test_result = js_eval(test_code)
    log_result(f"JS test - has iterator: {js_test_result.hasIterator}")
    
    if js_test_result.hasIterator:
        log_result("✅ Direct JS call works!")
        
        # Now test calling from Python
        log_result("Testing Python call...")
        
        python_items = ["py1", "py2", "py3"]
        js_items = to_js(python_items)
        log_result(f"Python items converted to JS: {type(js_items)}")
        
        python_result = window.crankPyCreateIterable(js_items)
        log_result(f"Python call result: {type(python_result)}")
        
        # Check if the Python result has Symbol.iterator
        iterator_symbol = Symbol.iterator
        python_has_iterator = iterator_symbol in python_result
        log_result(f"Python result has Symbol.iterator: {python_has_iterator}")
        
        if python_has_iterator:
            log_result("🎉 SUCCESS! Python call works too!")
        else:
            log_result("❌ Python call doesn't preserve Symbol.iterator")
            
            # Debug: check what properties the object has
            try:
                props_code = """
                (function(obj) {
                    const ownProps = Object.getOwnPropertyNames(obj);
                    const symbols = Object.getOwnPropertySymbols(obj);
                    return { ownProps: ownProps, symbolCount: symbols.length };
                })
                """
                props_func = js_eval(props_code)
                props_info = props_func(python_result)
                log_result(f"Object properties: {props_info.ownProps}")
                log_result(f"Symbol properties count: {props_info.symbolCount}")
            except Exception as e:
                log_result(f"Error checking properties: {e}")
    else:
        log_result("❌ Direct JS call failed")
        
except Exception as e:
    log_result(f"❌ Test failed: {e}")

log_result("Helper debug test completed")
    </script>
</body>
</html>