<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPython FFI Only</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
</head>
<body>
    <h1>MicroPython: FFI Dependencies Test</h1>
    <div id="output">Loading...</div>

    <py-config type="json">
        {
            "type": "micropython"
        }
    </py-config>

    <py-script>
        import js
        
        output = js.document.getElementById("output")
        output.innerHTML = "Testing dependencies our crank module needs<br><br>"
        
        def log(msg):
            output.innerHTML += msg + "<br>"
        
        # Test 1: Basic imports that crank module needs
        try:
            from js import Symbol, Object
            log("✅ js.Symbol and js.Object available")
        except Exception as e:
            log(f"❌ js imports failed: {e}")
            
        # Test 2: pyscript.ffi
        try:
            from pyscript.ffi import to_js, create_proxy
            log("✅ pyscript.ffi imports work")
        except Exception as e:
            log(f"❌ pyscript.ffi failed: {e}")
            
        # Test 3: pyodide.ffi (this might fail on MicroPython)
        try:
            from pyodide.ffi import JsProxy
            log("✅ pyodide.ffi.JsProxy available")
        except Exception as e:
            log(f"❌ pyodide.ffi.JsProxy failed: {e} (expected on MicroPython)")
            
        # Test 4: pyscript.js_modules (this is where crank_core would come from)
        try:
            from pyscript.js_modules import crank_core
            log("✅ pyscript.js_modules.crank_core available")
        except Exception as e:
            log(f"❌ pyscript.js_modules.crank_core failed: {e} (expected without Crank.js)")
            
        # Test 5: What we can test - basic object manipulation
        try:
            test_obj = Object.new()
            test_obj.test = "value"
            
            if hasattr(test_obj, 'as_object_map'):
                mapped = test_obj.as_object_map()
                log("✅ as_object_map works")
                
                # Test dynamic type access
                mapped_type = type(mapped)
                log(f"as_object_map type: {mapped_type}")
                
                # Can we modify the type? (key for our implementation)
                try:
                    def test_getitem(self, key):
                        return f"custom_getitem_{key}"
                    
                    mapped_type.__getitem__ = test_getitem
                    log("✅ Can modify as_object_map type")
                    
                    # Test if it works
                    result = mapped["test"]
                    log(f"Custom __getitem__ result: {result}")
                    
                except Exception as e:
                    log(f"❌ Cannot modify as_object_map type: {e}")
                    
            else:
                log("❌ as_object_map not available")
                
        except Exception as e:
            log(f"❌ Object manipulation failed: {e}")
            
        log("<br>=== SUMMARY ===")
        log("This tests if the core techniques our crank module")
        log("uses will work in MicroPython runtime")
    </py-script>
</body>
</html>