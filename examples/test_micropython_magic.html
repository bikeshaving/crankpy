<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPython Magic Syntax Test</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.2.4/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.2.4/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@b-fuze/crank@0.5.4/dist/index.umd.js"></script>
    <script>
        window.crank_core = window.Crank;
    </script>
</head>
<body>
    <div id="root"></div>
    
    <py-config>
        {
            "interpreter": "micropython",
            "packages": ["./crank"]
        }
    </py-config>

    <py-script>
        from js import document
        
        output_div = document.createElement("div")
        output_div.style.fontFamily = "monospace"
        output_div.style.whiteSpace = "pre-wrap"
        document.body.appendChild(output_div)
        
        def log(msg):
            output_div.innerHTML += msg + "\n"
        
        log("=== MicroPython Magic Syntax Test ===")
        
        # Test 1: Runtime detection
        try:
            import sys
            log(f"Python implementation: {sys.implementation.name}")
        except:
            log("Could not detect Python implementation")
        
        # Test 2: FFI availability
        try:
            from pyscript.ffi import to_js, create_proxy
            log("✅ pyscript.ffi available")
        except Exception as e:
            log(f"❌ pyscript.ffi: {e}")
            
        # Test 3: JS Object subscriptability
        try:
            from js import Object
            test_obj = Object.new()
            test_obj.key = "value"
            
            # Check for as_object_map
            if hasattr(test_obj, 'as_object_map'):
                log("✅ as_object_map available")
                mapped = test_obj.as_object_map()
                try:
                    result = mapped["key"]
                    log(f"✅ as_object_map subscripting works: {result}")
                except Exception as e:
                    log(f"❌ as_object_map subscripting fails: {e}")
            else:
                log("❌ as_object_map NOT available")
                
            # Test direct subscripting
            try:
                result = test_obj["key"]
                log(f"✅ Direct subscripting works: {result}")
            except Exception as e:
                log(f"❌ Direct subscripting fails: {e}")
                
        except Exception as e:
            log(f"❌ Object test failed: {e}")
            
        # Test 4: Crank integration
        try:
            from js import crank_core
            element = crank_core.createElement('div', None)
            log(f"✅ createElement works, type: {type(element)}")
            
            # Critical test: can we make it subscriptable?
            if hasattr(element, 'as_object_map'):
                log("✅ Crank element has as_object_map")
            else:
                log("❌ Crank element lacks as_object_map")
                
        except Exception as e:
            log(f"❌ Crank test failed: {e}")
            
        log("=== Test Complete ===")
    </py-script>
</body>
</html>