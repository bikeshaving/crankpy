<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Symbol Comparison Methods</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
</head>
<body>
    <div id="test-output"></div>
    
    <mpy-config>
        {
            "files": {
                "./crank/__init__.py": "crank/__init__.py",
                "./crank/dom.py": "crank/dom.py",
                "./crank/typing_stub.py": "crank/typing_stub.py"
            },
            "js_modules": {
                "main": {
                    "https://esm.run/@b9g/crank@0.7.1/crank.js": "crank_core",
                    "https://esm.run/@b9g/crank@0.7.1/dom.js": "crank_dom"
                }
            }
        }
    </mpy-config>
    
    <script type="mpy">
import sys
from js import document, Symbol
from pyscript.ffi import create_proxy

output_div = document.getElementById("test-output")

def log_result(message):
    output_div.innerHTML += f"<div>{message}</div>"

log_result(f"Python implementation: {sys.implementation.name}")

try:
    log_result("üîç Testing different Symbol comparison methods...")
    
    class SymbolTester:
        def __getitem__(self, key):
            log_result(f"Testing key: {key}")
            log_result(f"Key type: {type(key)}")
            
            # Method 1: Direct comparison
            try:
                direct_result = key == Symbol.iterator
                log_result(f"Direct comparison (key == Symbol.iterator): {direct_result}")
            except Exception as e:
                log_result(f"Direct comparison failed: {e}")
            
            # Method 2: String representation comparison
            try:
                key_str = str(key)
                symbol_str = str(Symbol.iterator)
                string_result = key_str == symbol_str
                log_result(f"String comparison ('{key_str}' == '{symbol_str}'): {string_result}")
            except Exception as e:
                log_result(f"String comparison failed: {e}")
            
            # Method 3: Type checking
            try:
                key_type = type(key)
                symbol_type = type(Symbol.iterator)
                type_result = key_type == symbol_type
                log_result(f"Type comparison ({key_type} == {symbol_type}): {type_result}")
            except Exception as e:
                log_result(f"Type comparison failed: {e}")
            
            # Method 4: Check if it looks like Symbol.iterator
            try:
                key_repr = repr(key)
                symbol_repr = repr(Symbol.iterator)
                repr_result = key_repr == symbol_repr
                log_result(f"Repr comparison ('{key_repr}' == '{symbol_repr}'): {repr_result}")
                
                # Also check if repr contains "iterator"
                contains_iterator = "iterator" in key_repr.lower()
                log_result(f"Key repr contains 'iterator': {contains_iterator}")
            except Exception as e:
                log_result(f"Repr comparison failed: {e}")
            
            # Method 5: JavaScript-side comparison
            try:
                # Create JavaScript function to compare
                js_comparison_code = """
                (function(pythonKey) {
                    try {
                        const result = pythonKey === Symbol.iterator;
                        return { success: true, result: result };
                    } catch (e) {
                        return { success: false, error: e.message };
                    }
                })
                """
                
                from js import eval as js_eval
                js_compare = js_eval(js_comparison_code)
                js_result = js_compare(key)
                
                if js_result.success:
                    log_result(f"JavaScript comparison (pythonKey === Symbol.iterator): {js_result.result}")
                else:
                    log_result(f"JavaScript comparison failed: {js_result.error}")
                    
            except Exception as e:
                log_result(f"JavaScript comparison error: {e}")
            
            # Method 6: Try using the key to create an iterator and see if it works
            try:
                # Check if we can access Symbol.iterator through the key
                test_object = {"test": "value"}
                test_object[key] = lambda: "iterator function"
                
                retrieved = test_object[Symbol.iterator]
                works_as_symbol = retrieved() == "iterator function"
                log_result(f"Key works as Symbol.iterator: {works_as_symbol}")
                
            except Exception as e:
                log_result(f"Key functionality test failed: {e}")
            
            return "TESTED"
    
    tester = SymbolTester()
    
    log_result("=== Testing with Symbol.iterator ===")
    result = tester[Symbol.iterator]
    
    log_result("=== Summary ===")
    log_result("Looking for a working comparison method...")
    
    # Based on results, try to create a working wrapper
    class WorkingSymbolWrapper:
        def __init__(self, generator):
            self.generator = generator
        
        def __getitem__(self, key):
            log_result(f"WorkingSymbolWrapper testing key: {key}")
            
            # Try multiple detection methods
            is_symbol_iterator = False
            
            # Method: Check string representation
            try:
                key_str = str(key)
                symbol_str = str(Symbol.iterator)
                if key_str == symbol_str:
                    is_symbol_iterator = True
                    log_result("‚úÖ Detected via string comparison")
            except:
                pass
            
            # Method: Check if repr contains iterator
            try:
                if "iterator" in repr(key).lower():
                    is_symbol_iterator = True
                    log_result("‚úÖ Detected via repr containing 'iterator'")
            except:
                pass
            
            # Method: Try JavaScript comparison
            try:
                js_code = "(function(k) { return k === Symbol.iterator; })"
                from js import eval as js_eval
                js_func = js_eval(js_code)
                if js_func(key):
                    is_symbol_iterator = True
                    log_result("‚úÖ Detected via JavaScript comparison")
            except:
                pass
            
            if is_symbol_iterator:
                log_result("üéØ Symbol.iterator detected! Creating iterator...")
                
                def iterator_function():
                    class Iterator:
                        def __init__(self, gen):
                            self.gen = gen
                        def next(self):
                            try:
                                value = next(self.gen)
                                return {"value": value, "done": False}
                            except StopIteration:
                                return {"value": None, "done": True}
                    return Iterator(self.generator)
                
                return create_proxy(iterator_function)
            
            raise KeyError(f"Not Symbol.iterator: {key}")
    
    # Test the working wrapper
    log_result("=== Testing WorkingSymbolWrapper ===")
    
    def test_gen():
        yield "working1"
        yield "working2"
    
    working_wrapper = WorkingSymbolWrapper(test_gen())
    
    try:
        iterator_func = working_wrapper[Symbol.iterator]
        log_result(f"‚úÖ Got working iterator: {type(iterator_func)}")
        
        iterator = iterator_func()
        result1 = iterator.next()
        result2 = iterator.next()
        result3 = iterator.next()
        
        log_result(f"Working results: {result1}, {result2}, {result3}")
        
    except Exception as e:
        log_result(f"‚ùå WorkingSymbolWrapper failed: {e}")
        
except Exception as e:
    log_result(f"‚ùå Test failed: {e}")

log_result("Symbol comparison methods test completed")
    </script>
</body>
</html>